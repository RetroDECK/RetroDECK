app-id: net.retrodeck.retrodeck
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp            # Needed for Steam ROM Manager
base-version: "25.08"
command: retrodeck

add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .
    version: '25.08'
cleanup-commands:
  - mkdir -p ${FLATPAK_DEST}/lib/ffmpeg

add-extensions:
  org.freedesktop.Platform.VulkanLayer.MangoHud:
    directory: mangohud
    add-ld-path: .
    version: '25.08'
cleanup-commands:
  - mkdir -p ${FLATPAK_DEST}/mangohud

finish-args:
  # Allow Wayland display server access
  - --socket=wayland
  # Allow X11 display server access
  - --socket=x11
  # Give the app access to PulseAudio for sound output/input
  - --socket=pulseaudio
  # Share the IPC namespace (needed for things like DBus communication)
  - --share=ipc
  # Share the network namespace (allows internet/network access)
  - --share=network
  # Give the app unrestricted device access (e.g., /dev/*)
  - --device=all
  # Give read/write access to the host filesystem (use with care)
  - --filesystem=host
  # Access the Steam Flatpak data directory in the user’s home
  - --filesystem=home/.var/app/com.valvesoftware.Steam
  # Enable multi‑arch support (e.g., 32‑bit libraries on 64‑bit systems)
  - --allow=multiarch
  # Talk to the screen‑saver DBus service (e.g., inhibit suspend)
  - --talk-name=org.freedesktop.ScreenSaver
  # Talk to the power‑management inhibit service
  - --talk-name=org.freedesktop.PowerManagement.Inhibit
  # Talk to systemd‑logind manager (session control)
  - --talk-name=org.freedesktop.login1.Manager
  # Create a writable runtime directory for Discord (used for sockets, etc.)
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  # Read‑only access to GTK‑3 configuration files
  - --filesystem=xdg-config/gtk-3.0:ro
  # Force Qt applications to use Wayland/EGL/XCB backends
  - --env=QT_QPA_PLATFORM=wayland;wayland-egl;xcb

# Dolphin
  # Allow Bluetooth device access
  - --allow=bluetooth

# SDL window‑class hints (help window managers group windows)
  - --env=SDL_VIDEO_X11_WMCLASS=net.retrodeck.retrodeck   # X11
  - --env=SDL_VIDEO_WAYLAND_WMCLASS=net.retrodeck.retrodeck # Wayland

# Steam ROM Manager
  - --filesystem=xdg-data/Steam:rw          # Flatpak‑installed Steam data
  - --filesystem=~/.steam:rw                # Non‑Flatpak Steam data
  - --filesystem=~/.var/app/com.valvesoftware.Steam:rw # Flatpak Steam data
  - --talk-name=org.freedesktop.DBus        # General DBus communication

# PPSSPP, Dolphin (gamescope integration)
  - --filesystem=xdg-run/gamescope-0:ro    # Read‑only access to gamescope socket

cleanup:
  # ES-DE
  - /include
  - /share/ffmpeg
  - /lib/cmake
  - /lib/pkgconfig
  - /include
  - /bin/glslangValidator
  - /bin/zip*
  - /bin/zstd*
  - /lib/pkg-config
  - /share/doc
  - /share/gtk-doc # Steam ROM Manager
  - /share/man
  - /src
  - '*.a'
  - '*.la'

modules:

  # This module is used to define the RetroDECK version
  # If the version is set as cooker it will automatically generate the version tag based on the date
  # else it will just put what is written, "v" is not needed
  # The version number is hardcoded in /app/retrodeck/version
  #
  # UPDATE STEPS FOR MAIN:
  # [ ] Update the net.retrodeck.retrodeck.metainfo.xml with the version number, date and notes

  - name: initialization
    buildsystem: simple
    build-commands:
      - |

        # Create the retrodeck directory in the Flatpak destination
        mkdir -p ${FLATPAK_DEST}/retrodeck/

        # Create the version file vital for RetroDECK Framework
        cp version ${FLATPAK_DEST}/retrodeck/version

        # Print the version number to the console
        echo "Version is $(cat ${FLATPAK_DEST}/retrodeck/version)"

        # Initializing RO retrodeck config folder
        mkdir -p ${FLATPAK_DEST}/retrodeck/graphics
        mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/
        mkdir -p ${FLATPAK_DEST}/retrodeck/components

    sources:
      - type: dir
        path: .

  # START: Internal RetroDECK tools

  - name: xmlstarlet
    config-opts:
      - --disable-static-libs
      - --with-libxml-libs-prefix=/usr/lib
      - --with-libxml-include-prefix=/usr/include/libxml2
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/xmlstar/xmlstarlet-1.6.1.tar.gz
        sha256: 15d838c4f3375332fd95554619179b69e4ec91418a3a5296e7c631b7ed19e7ca
      - type: shell
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} .
          - autoreconf -vfi
    post-install:
      - ln -s "xml" "${FLATPAK_DEST}/bin/xmlstarlet" ||:

  - name: rclone
    buildsystem: simple
    build-commands:
      - cp rclone ${FLATPAK_DEST}/bin/
    sources:
      - type: archive
        url: https://github.com/rclone/rclone/releases/download/v1.69.1/rclone-v1.69.1-linux-amd64.zip
        sha256: 231841f8d8029ae6cfca932b601b3b50d0e2c3c2cb9da3166293f1c3eae7d79c

  # Source: https://github.com/flathub/com.valvesoftware.Steam.Utility.steamtinkerlaunch/blob/master/modules/rsync.yml
  - name: rsync
    no-autogen: true
    config-opts:
      - --with-included-popt
      - --with-included-zlib
      - --disable-debug
    sources:
      - type: archive
        url: https://download.samba.org/pub/rsync/src/rsync-3.4.1.tar.gz
        sha256: 2924bcb3a1ed8b551fc101f740b9f0fe0a202b115027647cf69850d65fd88c52
        x-checker-data:
          type: anitya
          project-id: 4217
          stable-only: true
          url-template: https://download.samba.org/pub/rsync/src/rsync-$version.tar.gz
    modules:
      - name: xxhash
        no-autogen: true
        make-install-args:
          - PREFIX=${FLATPAK_DEST}
          - DISPATCH=1
        sources:
          - type: git
            url: https://github.com/Cyan4973/xxHash/
            tag: v0.8.3
            commit: e626a72bc2321cd320e953a0ccf1584cad60f363
            x-checker-data:
              type: anitya
              project-id: 17583
              stable-only: true
              tag-template: v$version

  - name: jq
    buildsystem: simple
    build-commands:
      - install -Dm755 jq-linux64 ${FLATPAK_DEST}/bin/jq
    sources:
      - type: file
        url: https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
        sha256: 5942c9b0934e510ee61eb3e30273f1b3fe2590df93933a93d7c58b81d19c8ff5

  - name: yq
    buildsystem: simple
    build-commands:
      - install -Dm755 yq_linux_amd64 ${FLATPAK_DEST}/bin/yq
    sources:
      - type: file
        url: https://github.com/mikefarah/yq/releases/download/v4.45.1/yq_linux_amd64
        sha256: 654d2943ca1d3be2024089eb4f270f4070f491a0610481d128509b2834870049

  - name: p7zip
    no-autogen: true
    sources:
      - type: archive
        url: https://github.com/p7zip-project/p7zip/archive/v17.04/p7zip-v17.04.tar.gz
        sha256: ea029a2e21d2d6ad0a156f6679bd66836204aa78148a4c5e498fe682e77127ef
      - type: shell
        commands:
          - sed -i 's|/usr/local|${FLATPAK_DEST}|g' makefile.common
    post-install:
      - mv "${FLATPAK_DEST}/bin/7za" "${FLATPAK_DEST}/bin/7z"
    cleanup:
      - /man

  # This installs all the RetroDECK components found in the components directory that is populated by retrodeck_builder.sh
  - name: install-components
    buildsystem: simple
    build-commands:
      - bash automation_tools/install_components.sh --cicd
    sources:
      - type: dir
        path: .

  # Temporary disabled, we will review this later
  # - name: "LibMan - Deduplication"
  #   buildsystem: simple
  #   build-commands:
  #     - bash libman.sh
  #   sources:
  #     - type: file
  #       path: automation_tools/libman.sh

  - name: finisher
    buildsystem: simple
    build-commands:

      # This prevents appstream-compose to fail
      - | 
        if [ -d ${FLATPAK_DEST}/usr ]; then
          mv -n ${FLATPAK_DEST}/usr/** ${FLATPAK_DEST}/share
          rm -rf ${FLATPAK_DEST}/usr
        fi

      # Logo, res, move graphics directory away from default location so splash can be changed after build
      - cp -f res/splash.svg ${FLATPAK_DEST}/retrodeck/graphics/splash.svg
      - cp -f res/splash.svg ${FLATPAK_DEST}/retrodeck/graphics/splash-orig.svg
      - cp -rf res/extra_splashes/ ${FLATPAK_DEST}/retrodeck/graphics
      - cp -rf res/lahrs_icons/ ${FLATPAK_DEST}/retrodeck/graphics
      - cp -f res/icon.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/net.retrodeck.retrodeck.svg
      - cp -f res/icon-configurator.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/net.retrodeck.retrodeck.configurator.svg
      - mv -f -t ${FLATPAK_DEST}/retrodeck res/binding_icons
      - mv -f -t ${FLATPAK_DEST}/retrodeck res/steam_grid

      # Tools
      - mkdir -p ${FLATPAK_DEST}/tools
      - cp -r tools/*.sh ${FLATPAK_DEST}/tools
      - find ${FLATPAK_DEST}/tools -type f \( -name "*.sh" -o -name "*.py" \) -exec chmod +x {} \;

      # Function libraries
      - mkdir -p ${FLATPAK_DEST}/libexec
      - cp -r functions/** "${FLATPAK_DEST}/libexec/"
      - mv "${FLATPAK_DEST}/libexec/retrodeck.sh" "${FLATPAK_DEST}/bin/retrodeck"
      - chmod +x "${FLATPAK_DEST}/bin/retrodeck"

      # Desktop entries
      - install -Dm755 net.retrodeck.retrodeck.desktop ${FLATPAK_DEST}/share/applications/net.retrodeck.retrodeck.desktop
      - install -Dm755 net.retrodeck.retrodeck.Configurator.desktop ${FLATPAK_DEST}/share/applications/net.retrodeck.retrodeck.Configurator.desktop

      # Initializing default emulator configs
      - cp -r config ${FLATPAK_DEST}/retrodeck/config/

      # Creating symlinks for a prettier access
      - ln -s ${FLATPAK_DEST}/tools/configurator.sh ${FLATPAK_DEST}/bin/configurator

      # Install MIME Type
      - install -Dm 644 config/retrodeck/net.retrodeck.retrodeck.mime.xml /app/share/mime/packages/net.retrodeck.retrodeck.mime.xml

      # Installing metainfo
      - install -Dm 644 net.retrodeck.retrodeck.metainfo.xml ${FLATPAK_DEST}/share/metainfo/net.retrodeck.retrodeck.metainfo.xml

      # Removing the retrodeck_function_wrapper.sh in non-cooker versions (aka main)
      - |
        if ! grep -q "cooker" "${FLATPAK_DEST}/retrodeck/version"; then
          rm -f "${FLATPAK_DEST}/tools/retrodeck_function_wrapper.sh"
        fi

      # Fix for Dolphin
      - ln -s "/app/retrodeck/components/dolphin/share/dolphin-emu" "/app/share/dolphin-emu"
    sources:
      - type: dir
        path: .

  - name: summary
    buildsystem: simple
    build-commands:
      - echo "RetroDECK Flatpak build completed successfully!"
      - echo "Version: $(cat ${FLATPAK_DEST}/retrodeck/version)"
      - echo "Flatpak path: ${FLATPAK_DEST}"
      - echo "Included components:"
      - ls -1 ${FLATPAK_DEST}/retrodeck/components
