app-id: com.xargon.retrodeck
runtime: org.kde.Platform
runtime-version: '5.15-21.08'
sdk: org.kde.Sdk
command: retrodeck.sh

finish-args:
   - --socket=x11
   - --socket=wayland
   - --socket=pulseaudio
   - --share=ipc
   - --share=network
   - --device=all
   - --filesystem=~/retrodeck:create
   - --allow=multiarch
   - --talk-name=org.freedesktop.ScreenSaver
   - --talk-name=org.freedesktop.PowerManagement.Inhibit
   - --talk-name=org.freedesktop.login1
   #- --filesystem=host
   - --filesystem=xdg-run/app/com.discordapp.Discord:create
  # Yuzu
   - --filesystem=home:ro
   - --filesystem=/run/media:ro

cleanup:
  # ES-DE
  - /include
  - /share/ffmpeg
  - /lib/cmake
  - /lib/debug
  - /lib/pkgconfig
  - /lib/libfreeimage.a
  - /lib/libogg.a
  - /lib/libvpx.a

modules:

  - name: xmlstarlet
    config-opts:
      - --disable-static-libs
      - --with-libxml-libs-prefix=/usr/lib
      - --with-libxml-include-prefix=/usr/include/libxml2
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/xmlstar/xmlstarlet-1.6.1.tar.gz
        sha256: 15d838c4f3375332fd95554619179b69e4ec91418a3a5296e7c631b7ed19e7ca
      - type: shell
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} .;
          - autoreconf -vfi;
    post-install:
      - ln -s "xml" "${FLATPAK_DEST}/bin/xmlstarlet" ||:;
    cleanup: ["*"]

  - name: kdialog
    buildsystem: cmake
    sources:
    - type: git
      url: https://github.com/KDE/kdialog.git
      tag: v22.03.80

  # ES-DE

  - name: fdk-aac
    buildsystem: cmake
    sources:
    - type: git
      url: https://git.code.sf.net/p/opencore-amr/fdk-aac.git
      tag: v2.0.2

  - name: libvpx
    config-opts:
    - --disable-examples
    - --disable-docs
    - --enable-pic
    - --enable-vp9-highbitdepth
    sources:
    - type: git
      url: https://github.com/webmproject/libvpx.git
      tag: v1.11.0

  - name: ogg
    buildsystem: cmake
    config-opts:
    - -DCMAKE_POSITION_INDEPENDENT_CODE=on
    - -DINSTALL_DOCS=off
    sources:
    - type: git
      url: https://github.com/xiph/ogg.git
      tag: v1.3.5

  - name: vorbis
    buildsystem: cmake
    config-opts:
    - -DBUILD_SHARED_LIBS=on
    sources:
    - type: git
      url: https://gitlab.xiph.org/xiph/vorbis.git
      tag: v1.3.7

  - name: opus
    buildsystem: cmake
    config-opts:
    - -DBUILD_SHARED_LIBS=on
    sources:
    - type: git
      url: https://gitlab.xiph.org/xiph/opus.git
      tag: v1.3.1

  - name: ffmpeg
    config-opts:
    - --disable-static
    - --disable-programs
    - --disable-doc
    - --enable-gpl
    - --enable-nonfree
    - --enable-shared
    - --enable-libvorbis
    - --enable-libopus
    - --enable-libfdk-aac
    - --enable-libvpx
    - --enable-postproc
    sources:
    - type: git
      url: https://github.com/FFmpeg/FFmpeg.git
      tag: n5.0

  - name: freeimage
    no-autogen: true
    build-options:
        cxxflags: -std=c++14
    make-args:
    - DESTDIR=/app
    sources:
    - type: archive
      url: http://downloads.sourceforge.net/freeimage/FreeImage3180.zip
      sha256: f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd
    - type: shell
      commands:
      - sed -i 's|-o root -g root ||' ./Makefile.gnu
      - sed -i 's|/usr|/app|' ./Makefile.gnu

  - name: pugixml
    buildsystem: cmake
    config-opts:
    - -DBUILD_SHARED_LIBS=on .
    sources:
    - type: archive
      url: https://github.com/zeux/pugixml/releases/download/v1.11.4/pugixml-1.11.4.tar.gz
      sha256: 8ddf57b65fb860416979a3f0640c2ad45ddddbbafa82508ef0a0af3ce7061716

  - name: emulationstation-de
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
    cleanup:
      - es-app
      - es-core
    sources:
    - type: git
      url: https://gitlab.com/leonstyhre/emulationstation-de.git
      branch: stable-1.2

  # ES-DE - END

  - name: art-book-next
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/emulationstation/themes/art-book-next-de/
      - mv -f * ${FLATPAK_DEST}/share/emulationstation/themes/art-book-next-de/
    sources:
      - type: git
        url: https://github.com/anthonycaccese/art-book-next-de.git
        branch: cba2e914128dd749df53e710b7c1feb9fc7b5cc8

  # Not part of the offical RetroArch manifest
  - name: retroarch-cores
    buildsystem: simple
    build-commands:
        - mkdir -p /app/share/libretro/cores/
        - mv ./RetroArch-Linux-x86_64.AppImage.home/.config/retroarch/cores/* /app/share/libretro/cores/
    cleanup:
        - RetroArch_cores.7z
    sources:
      - type: archive
        url: https://buildbot.libretro.com/stable/1.10.2/linux/x86_64/RetroArch_cores.7z
        sha256: 0c59f99534a1ae3a2d34b1747c40398325e53db69acfab35b99c8fa8d76430e5

  # Yuzu
  # Ryujinx
  # Xemu
  # Rpcs3
  # pcsx2
  # vita3k
  # dolphin
  # arduboy
 

  - name: retrodeck
    buildsystem: simple
    build-commands:

        # Prep the ES-DE and RetroArch config files
        - rm -rf /app/share/emulationstation/resources/systems/unix/es_find_rules.xml
        - cp es_find_rules.xml /app/share/emulationstation/resources/systems/unix/
        - rm -rf /app/share/emulationstation/resources/systems/unix/es_systems.xml
        - cp es_systems.xml /app/share/emulationstation/resources/systems/unix/
        # These must be put in home folder, managed by retrodeck.sh
        - mkdir -p ${FLATPAK_DEST}/retrodeck/
        - cp es_settings.xml ${FLATPAK_DEST}/retrodeck/es_settings.xml
        - cp retrodeck-retroarch.cfg ${FLATPAK_DEST}/retrodeck/retrodeck-retroarch.cfg

        # Logo, res
        - rm -f /app/share/emulationstation/resources/graphics/splash.svg
        - cp splash.svg /app/share/emulationstation/resources/graphics/splash.svg
        - cp icon.svg /app/share/icons/hicolor/scalable/apps/com.xargon.retrodeck.svg

        # Tools
        - mkdir -p ${FLATPAK_DEST}/retrodeck/tools/
        - cp start-retroarch.sh ${FLATPAK_DEST}/retrodeck/tools/
        - cp tools-gamelist.xml ${FLATPAK_DEST}/retrodeck/
        
        - cp retrodeck.sh /app/bin/retrodeck.sh
        - chmod +x /app/bin/retrodeck.sh

        # Desktop entry
        - cp desktop_entry /app/share/applications/com.xargon.retrodeck.desktop

    #cleanup: ['*']
    sources:
      - type: file
        path: es_find_rules.xml
      - type: file
        path: es_settings.xml
      - type: file
        path: es_systems.xml
      - type: file
        path: retrodeck.sh
      - type: file
        path: retrodeck-retroarch.cfg
      - type: file
        path: tools-gamelist.xml
      - type: dir
        path: res
      - type: dir
        path: tools
      - type: file
        path: desktop_entry