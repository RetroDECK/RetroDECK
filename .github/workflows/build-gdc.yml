name: Release Godot Configurator

on:
  push:
    branches: [ feat/godot-configurator ]
  pull_request:
    branches: [ feat/godot-configurator ]

#concurrency:
  #group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-devdesktop
#  cancel-in-progress: true

env:
  GODOT_VERSION: 4.2.2
  EXPORT_NAME: RetroDECK-Configurator
  TAG: v0.5

jobs:
  export-linux:
    name: Linux Export ğŸ§
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: tools/configurator
    container:
      image: docker://barichello/godot-ci:4.2.2
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Setup ğŸ’»
        run: |
          mkdir -v -p build/${EXPORT_NAME}-Linux-64bit ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
      - name: Import resources once ğŸ“¦
        continue-on-error: true
        run: godot --headless -v --import
      - name: Linux Build ğŸ”§
        continue-on-error: true
        run: |
          godot --headless -v --export-release "Linux/X11 64-bit" ~/$EXPORT_NAME.pck
      - name: Give execute permission â˜‘ï¸
        run: |
          chmod +x ~/$EXPORT_NAME.pck
      - name: Create tar.gz archive ğŸ—œï¸
        run: |
          tar zcvf ~/${EXPORT_NAME}.tar.gz ~/$EXPORT_NAME.pck
          
      - name: Upload Linux x86_64 Artifact ğŸš€
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.EXPORT_NAME}}
          path: ~/${{env.EXPORT_NAME}}.tar.gz
          retention-days: 14

      # Upload release linked to tag
      # had to explicity call file 
      - name: Upload Release Asset ğŸš€
        uses: svenstaro/upload-release-action@v2.9.0
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: /github/home/RetroDECK-*
          tag: ${{env.TAG}}
          overwrite: true
          file_glob: true